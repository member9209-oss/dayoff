<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>동선계획</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .input-container {
            position: relative;
        }
        .autocomplete-list {
            position: absolute;
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            list-style: none;
            padding: 0;
            margin: 0;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        .autocomplete-list.visible {
            opacity: 1;
            visibility: visible;
        }
        .autocomplete-list li {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f4f8;
        }
        .autocomplete-list li:hover {
            background-color: #f7fafc;
        }
        .autocomplete-list li:last-child {
            border-bottom: none;
        }
        .address-name {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 0.25rem;
        }
        .draggable-place {
            cursor: grab;
        }
        .dragging {
            opacity: 0.5;
        }
        .place-row .place-name-input {
            width: 35%;
        }
        .place-row .stay-duration-input {
            width: 15%;
        }
        .place-row .remark-input {
            width: 40%;
        }
        .no-select {
            user-select: none;
        }
        .results-table th, .results-table td {
            padding: 0.75rem 1rem;
        }
        .results-table th:nth-child(1), .results-table td:nth-child(1) { width: 25%; }
        .results-table th:nth-child(2), .results-table td:nth-child(2) { width: 15%; }
        .results-table th:nth-child(3), .results-table td:nth-child(3) { width: 30%; }
        .results-table th:nth-child(4), .results-table td:nth-child(4) { width: 30%; }
        .results-table .place-row td {
            font-weight: bold;
        }
        .capture-card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .capture-header {
            background-color: #e0f2fe;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            padding: 1rem 1.5rem;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .capture-table-container {
            padding: 1.5rem;
        }
        .capture-table th, .capture-table td {
            padding: 0.75rem;
        }
        .capture-table thead {
            background-color: #f3f4f6;
        }
        .capture-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* New styles for Favorite dropdown */
        .favorite-dropdown {
            position: relative;
            display: inline-block;
        }
        .favorite-content {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background-color: white;
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 20;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .favorite-content ul {
            max-height: 200px;
            overflow-y: auto;
            padding: 0;
            list-style: none;
        }
        .favorite-content li {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f0f4f8;
        }
        .favorite-content li:hover {
            background-color: #f7fafc;
        }

        @media (max-width: 768px) {
            .place-row {
                flex-wrap: wrap;
            }
            .place-row > div {
                width: 100%;
            }
            .place-row .place-name-input,
            .place-row .stay-duration-input,
            .place-row .remark-input {
                width: 100%;
                margin-top: 0.5rem;
            }
            /* 모바일에서 출발 시간/비고 입력 필드가 세로로 쌓이도록 조정 */
            .start-time-remark-row {
                 flex-direction: column;
                 align-items: flex-start !important;
            }
            .start-time-remark-row label.w-28 {
                 width: auto;
            }
            .start-time-remark-row select {
                 width: 100%;
            }
            .start-time-remark-row .w-16 {
                width: auto;
                margin-left: 0 !important;
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">비밀번호를 입력하세요</h3>
            <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg text-center" placeholder="비밀번호" onkeydown="handlePasswordKey(event)">
            <p id="password-error" class="text-sm text-red-500 mt-2 hidden">비밀번호가 올바르지 않습니다.</p>
            <button id="password-submit-btn" class="mt-4 bg-indigo-500 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-600 transition-colors">확인</button>
        </div>
    </div>

    <div id="filename-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-2xl">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">파일 저장 이름 입력</h3>
            <input type="text" id="filename-input" class="w-full p-3 border border-gray-300 rounded-lg text-center" placeholder="저장할 파일 이름 (확장자 제외)">
            <p id="filename-error" class="text-sm text-red-500 mt-2 hidden">파일 이름을 입력해주세요.</p>
            <div class="mt-4 flex justify-center gap-4">
                 <button id="filename-submit-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-full hover:bg-indigo-600 transition-colors">저장</button>
                 <button id="filename-cancel-btn" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-full hover:bg-gray-500 transition-colors">취소</button>
            </div>
        </div>
    </div>

    <div id="favorite-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-xl p-8 max-w-xl w-full shadow-2xl">
            <h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">즐겨찾기 장소 관리</h3>
            
            <div id="favorite-form" class="space-y-4 mb-6 p-4 border rounded-lg bg-gray-50">
                <p class="font-semibold text-gray-700">새 즐겨찾기 추가:</p>
                
                <!-- 1. Custom Name Input (나만의 이름) -->
                <div class="flex items-center gap-4">
                    <label class="text-gray-700 w-24">나만의 이름:</label>
                    <input type="text" id="fav-custom-name-input" class="flex-1 p-2 border border-gray-300 rounded-lg" placeholder="예: 해변 근처 카페">
                </div>
                
                <!-- 2. Specific Place Input (구체적 장소 - 자동완성) -->
                <div class="flex items-center gap-4 input-container">
                    <label class="text-gray-700 w-24">구체적 장소:</label>
                    <input type="text" id="fav-place-name-input" class="flex-1 p-2 border border-gray-300 rounded-lg" placeholder="장소명 입력 (자동완성)">
                    <ul class="autocomplete-list"></ul>
                </div>
                
                <button id="add-favorite-btn" class="w-full bg-green-500 text-white font-bold py-2 rounded-lg hover:bg-green-600 transition-colors">
                    <i class="fas fa-bookmark mr-2"></i>즐겨찾기 추가
                </button>
            </div>
            
            <div id="favorite-list-container" class="space-y-2 max-h-64 overflow-y-auto">
                </div>
            <p id="no-favorites" class="text-gray-500 text-center mt-4 hidden">등록된 즐겨찾기가 없습니다.</p>
            
            <div class="mt-6 flex justify-end">
                 <button id="close-favorite-modal-btn" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-full hover:bg-gray-500 transition-colors">닫기</button>
            </div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div class="container">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800">동선계획</h1>
                <p class="text-lg text-gray-500 mt-2">여행 일정을 효율적으로 계획해 보세요.</p>
            </header>

            <div id="app" class="space-y-8">
                <div class="flex justify-center gap-4 mb-8 flex-wrap">
                    <button id="manage-favorites-btn" class="bg-pink-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-pink-600 transition-colors">
                        <i class="fas fa-heart mr-2"></i>즐겨찾기 관리
                    </button>
                    <button id="save-btn" class="bg-gray-700 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-800 transition-colors">
                        <i class="fas fa-file-export mr-2"></i>저장 (.json)
                    </button>
                    <button id="load-btn" class="bg-gray-400 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-500 transition-colors">
                        <i class="fas fa-file-import mr-2"></i>불러오기 (.json)
                    </button>
                </div>
                
                <div id="day-container" class="space-y-8">
                    </div>

                <div class="flex justify-center gap-4 mt-8">
                    <button id="add-day-btn" class="bg-indigo-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-indigo-600 transition-colors">
                        <i class="fas fa-plus mr-2"></i>일정 추가
                    </button>
                    <button id="remove-day-btn" class="bg-red-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-minus mr-2"></i>일정 삭제
                    </button>
                    <button id="calculate-btn" class="bg-green-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-route mr-2"></i>동선 계산
                    </button>
                </div>

                <div id="results" class="mt-8 hidden">
                    <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">여행 동선 결과</h2>
                    <div id="results-container" class="space-y-6">
                        </div>
                </div>
            </div>

            <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
                <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center shadow-2xl">
                    <p id="notification-message" class="text-gray-800 text-lg"></p>
                    <div id="modal-button-container" class="mt-6 flex justify-center gap-2"></div>
                </div>
            </div>
            
            <input type="file" id="file-load-input" accept=".json" class="hidden">

            <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center hidden z-40">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                <p class="text-white text-lg">동선 계산 중...</p>
            </div>
        </div>
    </div>

    <script>
        const KAKAO_API_KEY = '569bb7ab8cbe696339ba922fa5dc101a';
        const CORRECT_PASSWORD = '2222'; // 비밀번호 설정
        
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const passwordError = document.getElementById('password-error');
        const mainContent = document.getElementById('main-content');
        
        const dayContainer = document.getElementById('day-container');
        const addDayBtn = document.getElementById('add-day-btn');
        const removeDayBtn = document.getElementById('remove-day-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const manageFavoritesBtn = document.getElementById('manage-favorites-btn'); // 즐겨찾기 관리 버튼
        const resultsDiv = document.getElementById('results');
        const resultsContainer = document.getElementById('results-container');
        const notificationModal = document.getElementById('notification-modal');
        const notificationMessage = document.getElementById('notification-message');
        const modalButtonContainer = document.getElementById('modal-button-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        const filenameModal = document.getElementById('filename-modal');
        const filenameInput = document.getElementById('filename-input');
        const filenameSubmitBtn = document.getElementById('filename-submit-btn');
        const filenameCancelBtn = document.getElementById('filename-cancel-btn');
        const filenameError = document.getElementById('filename-error');

        // Favorite Modal elements (UPDATED)
        const favoriteModal = document.getElementById('favorite-modal');
        const closeFavoriteModalBtn = document.getElementById('close-favorite-modal-btn');
        const favCustomNameInput = document.getElementById('fav-custom-name-input'); // '나만의 이름'
        const favPlaceNameInput = document.getElementById('fav-place-name-input'); // '구체적 장소' (자동완성)
        const addFavoriteBtn = document.getElementById('add-favorite-btn');
        const favoriteListContainer = document.getElementById('favorite-list-container');
        const noFavoritesText = document.getElementById('no-favorites');

        const fileLoadInput = document.getElementById('file-load-input');

        let dayCount = 0;
        let favorites = []; // 즐겨찾기 데이터를 저장할 배열
        
        // 즐겨찾기 폼 입력 필드에 데이터-속성을 추가하여 좌표를 임시 저장
        // 좌표는 '구체적 장소' 입력 필드에 저장됩니다.
        favPlaceNameInput.dataset.lat = '';
        favPlaceNameInput.dataset.lng = '';
        
        let lastDayEndPoint = {
            name: '제주공항 주차장출입구',
            coords: { lat: '33.507421', lng: '126.494208' }
        };
        const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'];

        // --- Password Check and Main Content Initialization ---
        async function checkPasswordAndInitialize() {
            if (passwordInput.value === CORRECT_PASSWORD) {
                passwordModal.classList.add('hidden');
                mainContent.classList.remove('hidden');
                // 즐겨찾기 데이터 로드
                favorites = loadFavorites();
                
                if (dayCount === 0) {
                    addDay(); 
                }
            } else {
                passwordError.classList.remove('hidden');
            }
        }
        
        // --- Favorite Management Functions (New Logic) ---
        function loadFavorites() {
            try {
                const stored = localStorage.getItem('travel_schedule_favorites');
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Failed to load favorites from localStorage:", e);
                return [];
            }
        }
        
        function saveFavorites() {
            try {
                localStorage.setItem('travel_schedule_favorites', JSON.stringify(favorites));
            } catch (e) {
                console.error("Failed to save favorites to localStorage:", e);
                showNotification("즐겨찾기 저장에 실패했습니다. 브라우저 저장 공간을 확인해주세요.");
            }
        }

        function renderFavoriteList() {
            favoriteListContainer.innerHTML = '';
            if (favorites.length === 0) {
                noFavoritesText.classList.remove('hidden');
                return;
            }
            noFavoritesText.classList.add('hidden');

            favorites.forEach((fav, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 border-b hover:bg-gray-50';
                
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${fav.customName}</p>
                        <p class="text-sm text-gray-500">장소: ${fav.place.name}</p> 
                    </div>
                    <button data-index="${index}" class="remove-fav-btn text-red-500 hover:text-red-700 transition-colors p-2">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                favoriteListContainer.appendChild(item);
            });
            
            // Attach delete events
            favoriteListContainer.querySelectorAll('.remove-fav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index);
                    favorites.splice(index, 1);
                    saveFavorites();
                    renderFavoriteList();
                    // 모든 드롭다운도 업데이트해야 함
                    updateAllFavoriteDropdowns(); 
                });
            });
        }
        
        manageFavoritesBtn.addEventListener('click', () => {
            renderFavoriteList();
            favoriteModal.classList.remove('hidden');
        });

        closeFavoriteModalBtn.addEventListener('click', () => {
            favoriteModal.classList.add('hidden');
            // 폼 초기화
            favCustomNameInput.value = '';
            favPlaceNameInput.value = '';
            favPlaceNameInput.dataset.lat = '';
            favPlaceNameInput.dataset.lng = '';
        });

        // Add Favorite Button Handler (UPDATED)
        addFavoriteBtn.addEventListener('click', () => {
            const customName = favCustomNameInput.value.trim();
            const placeName = favPlaceNameInput.value.trim();
            const lat = favPlaceNameInput.dataset.lat;
            const lng = favPlaceNameInput.dataset.lng;

            if (!customName || !placeName) {
                showNotification('나만의 이름과 구체적 장소명은 필수 입력 항목입니다.');
                return;
            }

            // 비주소성 장소명 (중식/석식)도 구체적 장소명으로 저장하려면 좌표 체크 로직을 제외해야 함
            const isNonAddress = ['중식', '석식', '점심', '저녁'].includes(placeName.toLowerCase());
            
            if (!isNonAddress && (lat === '' || lng === '')) {
                 showNotification('구체적 장소명을 입력 후 자동완성 리스트에서 정확한 장소를 선택해야 합니다.');
                 return;
            }

            favorites.push({
                id: Date.now(),
                customName: customName, // 요청 #2 반영
                place: { // 요청 #2 반영
                    name: placeName,
                    coords: { lat: lat, lng: lng }
                }
                // 체류시간, 비고는 저장하지 않음 (요청 #1 반영)
            });

            saveFavorites();
            renderFavoriteList();
            updateAllFavoriteDropdowns(); 
            
            // 폼 초기화
            favCustomNameInput.value = '';
            favPlaceNameInput.value = '';
            favPlaceNameInput.dataset.lat = '';
            favPlaceNameInput.dataset.lng = '';
        });
        
        // 즐겨찾기 폼에 자동 완성 연결 (이제 '구체적 장소'에만 연결)
        attachAutocomplete(favPlaceNameInput);

        // --- Helper functions ---
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        function clearModalButtons() {
            modalButtonContainer.innerHTML = '';
        }

        function showNotification(message) {
            clearModalButtons();
            notificationMessage.textContent = message;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '확인';
            closeBtn.className = 'bg-indigo-500 text-white py-2 px-4 rounded-full hover:bg-indigo-600 transition-colors';
            closeBtn.onclick = () => notificationModal.classList.add('hidden');
            
            modalButtonContainer.appendChild(closeBtn);
            notificationModal.classList.remove('hidden');
        }

        function showConfirmation(message, onConfirm) {
            clearModalButtons();
            notificationMessage.textContent = message;
            
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '삭제';
            confirmBtn.className = 'bg-red-500 text-white py-2 px-4 rounded-full hover:bg-red-700 transition-colors';
            confirmBtn.onclick = () => {
                notificationModal.classList.add('hidden');
                onConfirm();
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '취소';
            cancelBtn.className = 'bg-gray-400 text-white py-2 px-4 rounded-full hover:bg-gray-500 transition-colors';
            cancelBtn.onclick = () => notificationModal.classList.add('hidden');

            modalButtonContainer.appendChild(confirmBtn);
            modalButtonContainer.appendChild(cancelBtn);
            notificationModal.classList.remove('hidden');
        }

        function addDay() {
            dayCount++;
            const dayBlock = document.createElement('div');
            dayBlock.id = `day-${dayCount}`;
            dayBlock.className = 'p-6 bg-white rounded-2xl shadow-md border-t-4 border-indigo-500 space-y-4';

            let timeOptions = '';
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                    timeOptions += `<option value="${time}">${time}</option>`;
                }
            }

            let defaultDate = '';
            let defaultStartName = '';
            let defaultStartLat = '';
            let defaultStartLng = '';

            if (dayCount === 1) {
                defaultStartName = lastDayEndPoint.name;
                defaultStartLat = lastDayEndPoint.coords.lat;
                defaultStartLng = lastDayEndPoint.coords.lng;
            } else {
                const lastDayBlock = document.getElementById(`day-${dayCount - 1}`);
                const lastDateInput = lastDayBlock.querySelector('.date-input');
                if (lastDateInput && lastDateInput.value) {
                    const lastDate = new Date(lastDateInput.value);
                    lastDate.setDate(lastDate.getDate() + 1);
                    defaultDate = lastDate.toISOString().split('T')[0];
                }

                const lastDayPlaces = Array.from(lastDayBlock.querySelectorAll('.place-input')).filter(el => {
                    const placeName = el.querySelector('input[placeholder="장소명 입력"]').value;
                    const isNonAddress = ['중식', '석식', '점심', '저녁'].includes(placeName.toLowerCase());
                    return !isNonAddress && el.querySelector('input[placeholder="장소명 입력"]').dataset.lat;
                });

                if (lastDayPlaces.length > 0) {
                    const lastPlaceInput = lastDayPlaces[lastDayPlaces.length - 1].querySelector('input[placeholder="장소명 입력"]');
                    defaultStartName = lastPlaceInput.value;
                    defaultStartLat = lastPlaceInput.dataset.lat;
                    defaultStartLng = lastPlaceInput.dataset.lng;
                } else {
                     defaultStartName = lastDayEndPoint.name;
                     defaultStartLat = lastDayEndPoint.coords.lat;
                     defaultStartLng = lastDayEndPoint.coords.lng;
                }
            }

            dayBlock.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-indigo-700 w-28 no-select">${dayCount}일차</h3>
                    <input type="date" class="date-input p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" value="${defaultDate}">
                    
                    <div class="flex gap-2">
                        <div class="favorite-dropdown">
                            <button class="toggle-fav-btn bg-yellow-500 text-white font-bold py-2 px-4 rounded-full hover:bg-yellow-600 transition-colors">
                                <i class="fas fa-star mr-2"></i>즐겨찾기
                            </button>
                            <div class="favorite-content hidden">
                                <ul class="favorites-list-dropdown">
                                    </ul>
                            </div>
                        </div>
                        <button class="add-place-btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300 transition-colors">
                            <i class="fas fa-plus mr-2"></i>장소 추가
                        </button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex items-center gap-4 input-container">
                        <label for="start-point-${dayCount}" class="text-gray-700 w-28">출발 위치:</label>
                        <input type="text" id="start-point-${dayCount}" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="예: 제주국제공항" value="${defaultStartName}" data-lat="${defaultStartLat}" data-lng="${defaultStartLng}">
                        <ul class="autocomplete-list"></ul>
                    </div>
                    <div class="flex items-start sm:items-center flex-col sm:flex-row gap-4 start-time-remark-row">
                        <label for="start-time-${dayCount}" class="text-gray-700 w-28 shrink-0">출발 시간:</label>
                        <select id="start-time-${dayCount}" class="w-24 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400 shrink-0">
                           ${timeOptions}
                        </select>
                        <label for="start-remark-${dayCount}" class="text-gray-700 w-16 shrink-0 sm:ml-4">비고:</label>
                        <input type="text" id="start-remark-${dayCount}" class="flex-1 p-2 border border-gray-300 rounded-lg w-full sm:w-auto" placeholder="출발 비고 (예: 아침 식사, 숙소 체크아웃)">
                    </div>
                    </div>
                <div class="space-y-4 drag-container" id="places-container-${dayCount}">
                    <div class="flex items-center gap-4 place-input draggable-place place-row" draggable="true">
                        <label class="text-gray-700 place-label no-select">장소 1:</label>
                        <div class="flex-1 input-container place-name-input">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="장소명 입력">
                            <ul class="autocomplete-list"></ul>
                        </div>
                        <div class="w-24 stay-duration-input">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="체류 시간(분)">
                        </div>
                        <div class="flex-1 remark-input">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="비고 (예: 점심 식사)">
                        </div>
                        <i class="fas fa-times-circle text-red-500 cursor-pointer delete-place-btn no-select"></i>
                    </div>
                </div>
            `;
            dayContainer.appendChild(dayBlock);

            const addPlaceBtn = dayBlock.querySelector('.add-place-btn');
            addPlaceBtn.addEventListener('click', () => {
                const placesContainer = dayBlock.querySelector(`.drag-container`);
                const placeInput = createPlaceInput();
                placesContainer.appendChild(placeInput);
                attachAutocomplete(placeInput.querySelector('input[type="text"]'));
                updatePlaceLabels(dayBlock);
            });

            // 즐겨찾기 드롭다운 이벤트 연결
            attachFavoriteDropdown(dayBlock);

            attachAutocomplete(dayBlock.querySelector(`input[id^="start-point"]`));
            const initialPlaceInput = dayBlock.querySelector(`.place-input input[placeholder="장소명 입력"]`);
            attachAutocomplete(initialPlaceInput);
            attachDeleteEvents(dayBlock);
            attachDragAndDrop(dayBlock);
        }

        // 즐겨찾기 드롭다운 생성 및 이벤트 연결
        function attachFavoriteDropdown(dayBlock) {
            const dropdown = dayBlock.querySelector('.favorite-dropdown');
            const toggleBtn = dayBlock.querySelector('.toggle-fav-btn');
            const content = dayBlock.querySelector('.favorite-content');
            const list = dayBlock.querySelector('.favorites-list-dropdown');
            
            // 드롭다운 토글 기능
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                content.classList.toggle('hidden');
                if (!content.classList.contains('hidden')) {
                    renderFavoriteDropdownList(list);
                }
            });

            // 외부 클릭 시 닫기
            document.addEventListener('click', (e) => {
                if (!dropdown.contains(e.target)) {
                    content.classList.add('hidden');
                }
            });
            
            // 목록 클릭 시 장소 추가
            list.addEventListener('click', (e) => {
                const li = e.target.closest('li');
                if (li) {
                    const favId = parseInt(li.dataset.favId);
                    const fav = favorites.find(f => f.id === favId);
                    if (fav) {
                        const placesContainer = dayBlock.querySelector(`.drag-container`);
                        const placeInput = createPlaceInput(fav); // 새 즐겨찾기 구조를 넘겨줌
                        placesContainer.appendChild(placeInput);
                        attachAutocomplete(placeInput.querySelector('input[type="text"]'));
                        updatePlaceLabels(dayBlock);
                        content.classList.add('hidden'); // 추가 후 드롭다운 닫기
                    }
                }
            });
            
            // 최초 로드 시 목록 렌더링
            renderFavoriteDropdownList(list);
        }

        // 즐겨찾기 드롭다운 목록 렌더링 (UPDATED)
        function renderFavoriteDropdownList(listElement) {
            listElement.innerHTML = '';
            if (favorites.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500 text-center py-3">등록된 즐겨찾기 없음</li>';
                return;
            }

            favorites.forEach(fav => {
                const li = document.createElement('li');
                li.dataset.favId = fav.id;
                // fav.customName과 fav.place.name을 표시
                li.innerHTML = `
                    <div class="font-semibold">${fav.customName}</div>
                    <div class="text-xs text-gray-500 mt-0.5">${fav.place.name}</div>
                `;
                listElement.appendChild(li);
            });
        }
        
        // 모든 일차의 즐겨찾기 드롭다운 업데이트
        function updateAllFavoriteDropdowns() {
            document.querySelectorAll('.favorites-list-dropdown').forEach(list => {
                renderFavoriteDropdownList(list);
            });
        }

        // 장소 입력 필드 생성 (UPDATED Logic for Favorite Application)
        function createPlaceInput(fav = {}) {
            let placeDisplayName = fav.name || '';
            let placeLat = fav.coords?.lat || '';
            let placeLng = fav.coords?.lng || '';
            let placeStayDuration = fav.stayDuration || '';
            let placeRemark = fav.remark || '';
            
            // 파일 불러오기 시 (구조가 fav.name, fav.coords)가 아닌 
            // 즐겨찾기 드롭다운 클릭 시 (구조가 fav.customName, fav.place.name 등)의 경우
            if (fav.customName) { 
                // 이는 즐겨찾기 드롭다운에서 선택된 항목
                placeDisplayName = fav.place.name;
                placeLat = fav.place.coords.lat;
                placeLng = fav.place.coords.lng;
                placeStayDuration = ''; // 요청 #1: 체류 시간은 비워둠
                placeRemark = '';       // 요청 #1: 비고는 비워둠
            } else if (fav.name) {
                // 이는 파일에서 기존 일정의 장소를 불러올 때
                placeDisplayName = fav.name;
                placeLat = fav.coords?.lat || '';
                placeLng = fav.coords?.lng || '';
                placeStayDuration = fav.stayDuration || '';
                placeRemark = fav.remark || '';
            }

             const placeInput = document.createElement('div');
                placeInput.className = 'flex items-center gap-4 place-input draggable-place place-row';
                placeInput.setAttribute('draggable', 'true');
                placeInput.innerHTML = `
                    <label class="text-gray-700 place-label no-select">장소:</label>
                    <div class="flex-1 input-container place-name-input">
                        <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" 
                            placeholder="장소명 입력" 
                            value="${placeDisplayName}" 
                            data-lat="${placeLat}" 
                            data-lng="${placeLng}">
                        <ul class="autocomplete-list"></ul>
                    </div>
                    <div class="w-24 stay-duration-input">
                        <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" 
                            placeholder="체류 시간(분)" 
                            value="${placeStayDuration}">
                    </div>
                    <div class="flex-1 remark-input">
                        <input type="text" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-400" 
                            placeholder="비고 (예: 점심 식사)" 
                            value="${placeRemark}">
                    </div>
                    <i class="fas fa-times-circle text-red-500 cursor-pointer delete-place-btn no-select"></i>
                `;
            return placeInput;
        }


        function removeDay() {
            if (dayCount > 1) {
                const lastDayBlock = document.getElementById(`day-${dayCount}`);
                dayContainer.removeChild(lastDayBlock);
                dayCount--;
                const lastDayBlockPlaces = document.getElementById(`day-${dayCount}`);
                
                if (lastDayBlockPlaces) {
                    const placeInputs = lastDayBlockPlaces.querySelectorAll('.place-input');
                    const lastPlaceInput = placeInputs.length > 0 
                        ? placeInputs[placeInputs.length - 1].querySelector('input[placeholder="장소명 입력"]')
                        : null;
                    
                    if (lastPlaceInput && lastPlaceInput.dataset.lat) {
                        lastDayEndPoint = {
                            name: lastPlaceInput.value,
                            coords: { lat: lastPlaceInput.dataset.lat, lng: lastPlaceInput.dataset.lng }
                        };
                    } else {
                        lastDayEndPoint = {
                             name: '제주공항 주차장출입구',
                             coords: { lat: '33.507421', lng: '126.494208' }
                        };
                    }
                }
                
            } else {
                showNotification('마지막 일정은 삭제할 수 없습니다. 일정을 초기화하려면 새로고침하세요.');
            }
        }
        
        function updatePlaceLabels(dayBlock) {
            const placesContainer = dayBlock.querySelector(`.drag-container`);
            const placeInputs = placesContainer.querySelectorAll('.place-input');
            placeInputs.forEach((input, index) => {
                const label = input.querySelector('.place-label');
                // label이 장소 입력 필드와 항상 동등한 위치에 있도록
                if(label) label.textContent = `장소 ${index + 1}:`;
            });
        }

        function attachDeleteEvents(dayBlock) {
            dayBlock.addEventListener('click', (e) => {
                if (e.target.classList.contains('delete-place-btn')) {
                    const placeInput = e.target.closest('.place-input');
                    if (placeInput) {
                        placeInput.remove();
                        updatePlaceLabels(dayBlock);
                    }
                }
            });
        }
        
        function attachDragAndDrop(dayBlock) {
            const placesContainer = dayBlock.querySelector(`.drag-container`);
            let dragSrcEl = null;

            placesContainer.addEventListener('dragstart', (e) => {
                const target = e.target.closest('.draggable-place');
                if (target) {
                    dragSrcEl = target;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', dragSrcEl.outerHTML);
                    dragSrcEl.classList.add('dragging');
                }
            });

            placesContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                const target = e.target.closest('.draggable-place');
                if (target) {
                    const rect = target.getBoundingClientRect();
                    const isAfter = e.clientY > rect.top + rect.height / 2;
                    target.style.borderTop = isAfter ? '' : '2px solid #6366f1';
                    target.style.borderBottom = isAfter ? '2px solid #6366f1' : '';
                }
            });

            placesContainer.addEventListener('dragleave', (e) => {
                const target = e.target.closest('.draggable-place');
                if (target) {
                    target.style.borderTop = '';
                    target.style.borderBottom = '';
                }
            });

            placesContainer.addEventListener('drop', (e) => {
                e.stopPropagation();
                const dropTarget = e.target.closest('.draggable-place');
                if (dropTarget && dragSrcEl && dragSrcEl !== dropTarget) {
                    const rect = dropTarget.getBoundingClientRect();
                    const isAfter = e.clientY > rect.top + rect.height / 2;
                    
                    if (isAfter) {
                        dropTarget.parentNode.insertBefore(dragSrcEl, dropTarget.nextSibling);
                    } else {
                        dropTarget.parentNode.insertBefore(dragSrcEl, dropTarget);
                    }
                    updatePlaceLabels(dayBlock);
                }
                document.querySelectorAll('.draggable-place').forEach(el => {
                    el.style.borderTop = '';
                    el.style.borderBottom = '';
                    el.classList.remove('dragging');
                });
            });

            placesContainer.addEventListener('dragend', () => {
                 document.querySelectorAll('.draggable-place').forEach(el => {
                    el.classList.remove('dragging');
                });
            });
        }

        function attachAutocomplete(inputElement) {
            const listElement = inputElement.closest('.input-container').querySelector('.autocomplete-list');
            let debounceTimeout;
            let lastQuery = '';

            inputElement.addEventListener('input', (e) => {
                clearTimeout(debounceTimeout);
                const query = e.target.value;
                if (query.length < 2) {
                    listElement.innerHTML = '';
                    listElement.classList.remove('visible');
                    // 장소명, 좌표 초기화
                    delete inputElement.dataset.lat;
                    delete inputElement.dataset.lng;
                    return;
                }

                if (query === lastQuery) return;
                lastQuery = query;

                debounceTimeout = setTimeout(() => {
                    searchKakaoPlaces(query, listElement);
                }, 300);
            });

            inputElement.addEventListener('focus', () => {
                if (listElement.children.length > 0) {
                    listElement.classList.add('visible');
                }
            });
            
            inputElement.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!listElement.contains(document.activeElement)) {
                        listElement.classList.remove('visible');
                    }
                }, 100);
            });

            listElement.addEventListener('mousedown', (e) => {
                const li = e.target.closest('li');
                if (li) {
                    const inputElement = li.closest('.input-container').querySelector('input');
                    // 장소명 입력 후 좌표와 장소명 속성 저장
                    inputElement.value = li.dataset.name;
                    inputElement.dataset.lat = li.dataset.lat;
                    inputElement.dataset.lng = li.dataset.lng;
                    listElement.classList.remove('visible');
                }
            });
        }

        async function searchKakaoPlaces(query, listElement) {
            const url = `https://dapi.kakao.com/v2/local/search/keyword.json?query=${encodeURIComponent(query)}`;
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Authorization': `KakaoAK ${KAKAO_API_KEY}` }
                });
                const data = await response.json();
                
                listElement.innerHTML = '';
                if (data.documents && data.documents.length > 0) {
                    data.documents.forEach(place => {
                        const li = document.createElement('li');
                        li.className = 'py-2 px-4 cursor-pointer';
                        li.dataset.lat = place.y;
                        li.dataset.lng = place.x;
                        li.dataset.name = place.place_name;
                        li.innerHTML = `
                            <div class="font-semibold">${place.place_name}</div>
                            <div class="text-xs text-gray-500 mt-0.5">${place.address_name}</div>
                        `;
                        listElement.appendChild(li);
                    });
                    listElement.classList.add('visible');
                } else {
                    listElement.classList.remove('visible');
                }
            } catch (error) {
                console.error('카카오 API 검색 오류:', error);
                listElement.classList.remove('visible');
            }
        }
        
        addDayBtn.addEventListener('click', addDay);
        removeDayBtn.addEventListener('click', removeDay);

        calculateBtn.addEventListener('click', async () => {
            showLoading();
            const allSchedules = [];
            for (let i = 1; i <= dayCount; i++) {
                const daySchedule = { places: [] };
                const dayBlock = document.getElementById(`day-${i}`);
                const dateInput = dayBlock.querySelector('.date-input');
                const startTimeInput = dayBlock.querySelector(`#start-time-${i}`); 
                const startPointInput = dayBlock.querySelector(`input[id^="start-point"]`);
                const startRemarkInput = dayBlock.querySelector(`input[id^="start-remark"]`);
                
                if (!startPointInput.value) {
                    hideLoading();
                    showNotification(`${i}일차 출발 위치를 입력해주세요.`);
                    return;
                }
                
                if (!startPointInput.dataset.lat || !startPointInput.dataset.lng) {
                    hideLoading();
                    showNotification(`"${startPointInput.value}"의 주소를 선택해주세요. 리스트에서 정확한 장소를 클릭해야 합니다.`);
                    return;
                }
                
                const dateString = dateInput.value;
                daySchedule.date = dateString ? new Date(dateString) : null;

                daySchedule.startTime = startTimeInput.value;
                daySchedule.startPoint = {
                    name: startPointInput.value,
                    coords: { lat: startPointInput.dataset.lat, lng: startPointInput.dataset.lng },
                    remark: startRemarkInput.value
                };

                const placesInputs = dayBlock.querySelectorAll(`.place-input`);
                for (let j = 0; j < placesInputs.length; j++) {
                    const placeInputDiv = placesInputs[j];
                    const placeNameInput = placeInputDiv.querySelector('input[placeholder="장소명 입력"]');
                    const stayDurationInput = placeInputDiv.querySelector('input[placeholder="체류 시간(분)"]');
                    const remarkInput = placeInputDiv.querySelector('input[placeholder^="비고"]');
                    
                    if (placeNameInput.value) {
                        const placeName = placeNameInput.value.trim().toLowerCase();
                        const isNonAddress = ['중식', '석식', '점심', '저녁'].includes(placeName);
                        
                        if (!isNonAddress && (!placeNameInput.dataset.lat || !placeNameInput.dataset.lng)) {
                            hideLoading();
                             showNotification(`"${placeNameInput.value}"의 주소를 선택해주세요. 리스트에서 정확한 장소를 클릭해야 합니다.`);
                             return;
                        }

                        if (!stayDurationInput.value.trim()) {
                            hideLoading();
                            showNotification(`"${placeNameInput.value}"의 체류 시간을 입력해주세요.`);
                            return;
                        }

                        daySchedule.places.push({
                            name: placeNameInput.value,
                            coords: isNonAddress ? null : { lat: placeNameInput.dataset.lat, lng: placeNameInput.dataset.lng },
                            stayDuration: stayDurationInput.value,
                            remark: remarkInput ? remarkInput.value : ''
                        });
                    }
                }
                
                if (daySchedule.places.length > 0) {
                    allSchedules.push(daySchedule);
                }
            }

            if (allSchedules.length === 0) {
                hideLoading();
                showNotification('일정을 추가하고 장소를 입력해주세요.');
                return;
            }

            resultsContainer.innerHTML = '';
            resultsDiv.classList.remove('hidden');
            
            for (let i = 0; i < allSchedules.length; i++) {
                await processSchedule(allSchedules[i], i + 1);
            }
            hideLoading();
        });

        async function processSchedule(daySchedule, dayIndex) {
            const { startTime, startPoint, places, date } = daySchedule;
            
            let travelPlan = [];
            let currentPoint = startPoint;
            let currentTime;
            let waypoints = [];
            
            let initialDate = date || new Date(); 
            const [hours, minutes] = startTime.split(':').map(Number);
            currentTime = new Date(initialDate);
            currentTime.setHours(hours, minutes, 0, 0);


            let totalTravelDuration = 0;

            for (let i = 0; i < places.length; i++) {
                const destination = places[i];
                let travelDuration = 0;
                let routeLink = null;
                
                const segmentFrom = currentPoint;
                const segmentTo = destination;

                if (destination.coords && currentPoint.coords) {
                    const travelResult = await getDrivingDuration(currentPoint, destination);
                    travelDuration = travelResult.duration;
                    
                    // 경로가 유효할 경우에만 링크 생성
                    if (travelDuration > 0 || travelResult.routeFound) {
                        routeLink = `https://map.kakao.com/link/from/${segmentFrom.name},${segmentFrom.coords.lat},${segmentFrom.coords.lng}/to/${segmentTo.name},${segmentTo.coords.lat},${segmentTo.coords.lng}`;
                    }
                    
                    // 경로를 찾지 못했으나 크래시를 방지했으므로, travelDuration은 0이거나 계산된 값일 것임.
                }
                
                const arrivalTime = new Date(currentTime.getTime() + travelDuration * 60 * 1000);
                totalTravelDuration += travelDuration;

                const stayDurationValue = (destination.stayDuration === '일정종료' || destination.stayDuration.toLowerCase() === '일정종료') ? '일정종료' : parseInt(destination.stayDuration);
                
                const departureTime = (stayDurationValue !== '일정종료') ? new Date(arrivalTime.getTime() + stayDurationValue * 60 * 1000) : null;
                
                let travelStatus = travelDuration > 0 ? `${travelDuration}분 소요` : (destination.coords && currentPoint.coords ? '경로 미탐색' : '장소 이동 없음');

                travelPlan.push({
                    from: segmentFrom.name,
                    to: segmentTo.name,
                    travelDuration: travelDuration,
                    arrivalTime: arrivalTime,
                    stayDuration: stayDurationValue,
                    departureTime: departureTime,
                    remark: destination.remark,
                    routeLink: routeLink,
                    travelStatus: travelStatus // 결과 테이블에 표시할 상태 추가
                });
                
                if (stayDurationValue === '일정종료') {
                    break;
                }
                
                if (destination.coords) {
                    currentPoint = destination;
                    waypoints.push(currentPoint);
                }
                currentTime = departureTime;
            }
            
            const firstPlaceWithCoords = places.find(p => p.coords);
            let fullRouteLink = null;
            if (startPoint.coords && firstPlaceWithCoords) {
                const validWaypoints = waypoints.filter(wp => wp.coords);
                
                let originParam = `${startPoint.name},${startPoint.coords.lat},${startPoint.coords.lng}`;
                let destinationParam = '';
                let waypointsParam = '';

                if (validWaypoints.length > 0) {
                    destinationParam = `${validWaypoints[validWaypoints.length - 1].name},${validWaypoints[validWaypoints.length - 1].coords.lat},${validWaypoints[validWaypoints.length - 1].coords.lng}`;
                    if (validWaypoints.length > 1) {
                         waypointsParam = validWaypoints.slice(0, -1).map(wp => `${wp.name},${wp.coords.lat},${wp.coords.lng}`).join('/');
                         fullRouteLink = `https://map.kakao.com/link/to/${originParam}/via/${waypointsParam}/${destinationParam}`;
                    } else {
                         fullRouteLink = `https://map.kakao.com/link/from/${originParam}/to/${destinationParam}`;
                    }
                } else {
                    fullRouteLink = `https://map.kakao.com/link/from/${originParam}/to/${firstPlaceWithCoords.name},${firstPlaceWithCoords.coords.lat},${firstPlaceWithCoords.coords.lng}`;
                }
            }


            renderResults(daySchedule, travelPlan, totalTravelDuration, dayIndex, fullRouteLink);
        }

        async function getDrivingDuration(start, end) {
            const url = `https://apis-navi.kakaomobility.com/v1/directions?origin=${start.coords.lng},${start.coords.lat}&destination=${end.coords.lng},${end.coords.lat}`;
            let retryCount = 0;
            const maxRetries = 3;
            let duration = 0;
            let routeFound = false; // 경로 탐색 성공 여부

            while (retryCount < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Authorization': `KakaoAK ${KAKAO_API_KEY}` }
                    });
                    const json = await response.json();
                    
                    // 🚨🚨🚨 방어적 코드 시작 🚨🚨🚨
                    if (json.routes && json.routes.length > 0 && json.routes[0].summary) {
                        const route = json.routes[0];
                        const durationInSeconds = route.summary.duration;
                        duration = Math.floor(durationInSeconds / 60);
                        routeFound = true; 
                        break; // 성공하면 루프 종료
                    } else if (json.code === 104) {
                        // 104: 경로 탐색 결과 없음 (좌표는 유효하나 길찾기 불가)
                        console.warn(`경로 탐색 불가: ${start.name} -> ${end.name}`);
                        duration = 0; // 경로 없으면 0분으로 처리
                        routeFound = false; 
                        break; // 경로를 못찾은 것이므로 재시도 불필요
                    } else {
                        // 기타 예상치 못한 응답 구조
                        throw new Error("Unexpected API response structure or data."); 
                    }
                    // 🚨🚨🚨 방어적 코드 끝 🚨🚨🚨
                } catch (error) {
                    retryCount++;
                    if (retryCount < maxRetries) {
                        console.error(`카카오 내비 API 호출 실패 (재시도 ${retryCount}):`, error.message);
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount - 1) * 1000));
                    } else {
                        console.error('카카오 내비 API 호출 실패 (최대 재시도 횟수 초과):', error.message);
                        // 최대 재시도 후에도 실패하면 duration 0으로 처리하고 루프 종료
                        duration = 0;
                        routeFound = false;
                        break; 
                    }
                }
            }

            return { duration: duration, routeFound: routeFound };
        }
        
        function renderResults(daySchedule, travelPlan, totalTravelDuration, dayIndex, fullRouteLink) {
            const dayResultBlock = document.createElement('div');
            dayResultBlock.id = `result-day-${dayIndex}`;
            dayResultBlock.className = 'capture-card';
            
            const dayTitle = document.createElement('div');
            dayTitle.className = 'capture-header text-xl font-bold';
            
            let displayTitle = `${dayIndex}일차`;
            if (daySchedule.date) {
                const month = daySchedule.date.getMonth() + 1;
                const day = daySchedule.date.getDate();
                const dayString = dayOfWeek[daySchedule.date.getDay()];
                displayTitle += ` ${month}/${day}(${dayString})`;
            }

            dayTitle.innerHTML = `
                <span class="text-gray-800">${displayTitle}</span>
                <div class="flex gap-2">
                    ${fullRouteLink ? `<a href="${fullRouteLink}" target="_blank" class="bg-blue-500 text-white text-sm py-1 px-3 rounded-full hover:bg-blue-600 transition-colors">
                        <i class="fas fa-map mr-1"></i>전체 경로 보기
                    </a>` : ''}
                    <button class="bg-blue-500 text-white text-sm py-1 px-3 rounded-full hover:bg-blue-600 transition-colors capture-btn" onclick="captureElement('result-day-${dayIndex}', '${displayTitle}')">
                        <i class="fas fa-camera mr-1"></i>캡처하기
                    </button>
                </div>
            `;
            dayResultBlock.appendChild(dayTitle);

            const tableContainer = document.createElement('div');
            tableContainer.className = 'capture-table-container';
            
            const resultsTable = document.createElement('table');
            resultsTable.className = 'w-full text-left table-auto';
            resultsTable.innerHTML = `
                <thead>
                    <tr class="text-gray-600 uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left">시간</th>
                        <th class="py-3 px-6 text-left">소요시간</th>
                        <th class="py-3 px-6 text-left">장소/경로</th>
                        <th class="py-3 px-6 text-left">비고</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 text-sm font-light">
                </tbody>
            `;
            const tbody = resultsTable.querySelector('tbody');

            let lastTime;
            if (daySchedule.date) {
                const [hours, minutes] = daySchedule.startTime.split(':').map(Number);
                lastTime = new Date(daySchedule.date.getFullYear(), daySchedule.date.getMonth(), daySchedule.date.getDate(), hours, minutes);
            } else {
                const [hours, minutes] = daySchedule.startTime.split(':').map(Number);
                lastTime = new Date();
                lastTime.setHours(hours, minutes, 0, 0);
            }
            
            let totalStayMinutes = 0;
            let totalElapsedTime = 0;

            const startRow = document.createElement('tr');
            startRow.className = 'border-b border-gray-200 hover:bg-gray-100';
            startRow.innerHTML = `
                <td class="py-3 px-6 text-left whitespace-nowrap">${Utilities.formatTime(lastTime)}</td>
                <td class="py-3 px-6 text-left"></td>
                <td class="py-3 px-6 text-left font-bold text-gray-800">${daySchedule.startPoint.name} (출발)</td>
                <td class="py-3 px-6 text-left">${daySchedule.startPoint.remark || ''}</td> 
            `;
            tbody.appendChild(startRow);

            travelPlan.forEach(item => {
                const travelStartTime = lastTime;
                const travelEndTime = item.arrivalTime;
                
                const travelRow = document.createElement('tr');
                travelRow.className = 'bg-gray-50 border-b border-gray-200 hover:bg-gray-100';
                
                const travelDurationText = item.travelStatus === '경로 미탐색' 
                    ? `<span class="text-red-500 font-bold">${item.travelStatus}</span>`
                    : item.travelStatus;

                travelRow.innerHTML = `
                    <td class="py-2 px-6 text-left">${Utilities.formatTime(travelStartTime)} ~ ${Utilities.formatTime(travelEndTime)}</td>
                    <td class="py-2 px-6 text-left text-gray-600">${travelDurationText}</td>
                    <td class="py-2 px-6 text-left">${item.from} → ${item.to}
                        ${item.routeLink ? `<a href="${item.routeLink}" target="_blank" class="text-blue-500 hover:underline ml-2"><i class="fas fa-map-marker-alt"></i></a>` : ''}
                    </td>
                    <td class="py-2 px-6 text-left"></td>
                `;

                tbody.appendChild(travelRow);
                
                totalElapsedTime += item.travelDuration;

                const placeRow = document.createElement('tr');
                placeRow.className = 'border-b border-gray-200 hover:bg-gray-100 font-medium text-gray-800';
                
                const stayDurationText = item.stayDuration === '일정종료' ? '일정 종료' : `${item.stayDuration}분`;
                if (item.stayDuration !== '일정종료' && !isNaN(parseInt(item.stayDuration))) {
                    totalStayMinutes += parseInt(item.stayDuration);
                    totalElapsedTime += parseInt(item.stayDuration);
                }

                const arrivalTimeText = `${Utilities.formatTime(item.arrivalTime)} ~ ${item.departureTime ? Utilities.formatTime(item.departureTime) : '일정 종료'}`;

                placeRow.innerHTML = `
                    <td class="py-3 px-6 text-left">${arrivalTimeText}</td>
                    <td class="py-3 px-6 text-left">${stayDurationText}</td>
                    <td class="py-3 px-6 text-left font-bold">${item.to}</td>
                    <td class="py-3 px-6 text-left">${item.remark || ''}</td>
                `;
                tbody.appendChild(placeRow);
                
                if (item.departureTime) {
                    lastTime = item.departureTime;
                }
            });

            tableContainer.appendChild(resultsTable);
            
            const finalTotalDuration = totalTravelDuration + totalStayMinutes;
            const summary = document.createElement('div');
            summary.className = 'mt-6 text-center text-gray-700 font-semibold';
            summary.innerHTML = `
                <p class="text-xl no-select">
                    총 소요시간: <span class="text-green-600 font-bold">${Utilities.formatDuration(finalTotalDuration)}</span>
                    <span class="text-gray-500 font-normal">(총 이동시간: ${Utilities.formatDuration(totalTravelDuration)})</span>
                </p>
            `;
            tableContainer.appendChild(summary);

            dayResultBlock.appendChild(tableContainer);
            resultsContainer.appendChild(dayResultBlock);
        }
        
        const Utilities = {
            formatTime: (date) => {
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            },
            formatDuration: (totalMinutes) => {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours > 0 ? `${hours}시간 ` : ''}${minutes}분`;
            }
        };

        window.captureElement = function(elementId, filename) {
            const element = document.getElementById(elementId);
            if (!element) {
                showNotification('캡처할 요소를 찾을 수 없습니다.');
                return;
            }

            const captureBtn = element.querySelector('.capture-btn');
            if (captureBtn) {
                captureBtn.style.display = 'none';
            }

            html2canvas(element, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `${filename}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                if (captureBtn) {
                    captureBtn.style.display = '';
                }

                showNotification(`${filename}이(가) 성공적으로 캡처되었습니다.`);
            });
        };

        // --- PC File Save/Load functionality ---

        function exportScheduleData() {
            const schedules = [];
            for (let i = 1; i <= dayCount; i++) {
                const dayBlock = document.getElementById(`day-${i}`);
                if (!dayBlock) continue;
                
                const dateInput = dayBlock.querySelector('.date-input');
                const startTimeInput = dayBlock.querySelector(`#start-time-${i}`);
                const startPointInput = dayBlock.querySelector(`input[id^="start-point"]`);
                const startRemarkInput = dayBlock.querySelector(`input[id^="start-remark"]`);
                const placesInputs = dayBlock.querySelectorAll(`.place-input`);

                const placesData = [];
                placesInputs.forEach(placeInputDiv => {
                    const placeNameInput = placeInputDiv.querySelector('input[placeholder="장소명 입력"]');
                    const stayDurationInput = placeInputDiv.querySelector('input[placeholder="체류 시간(분)"]');
                    const remarkInput = placeInputDiv.querySelector('input[placeholder^="비고"]');
                    
                    placesData.push({
                        name: placeNameInput.value,
                        coords: { lat: placeNameInput.dataset.lat || '', lng: placeNameInput.dataset.lng || '' },
                        stayDuration: stayDurationInput.value,
                        remark: remarkInput ? remarkInput.value : ''
                    });
                });

                schedules.push({
                    dayIndex: i,
                    date: dateInput.value,
                    startTime: startTimeInput.value,
                    startPoint: {
                        name: startPointInput.value,
                        coords: { lat: startPointInput.dataset.lat || '', lng: startPointInput.dataset.lng || '' },
                        remark: startRemarkInput.value || ''
                    },
                    places: placesData
                });
            }

            return {
                dayCount: dayCount,
                schedules: schedules,
                favorites: favorites, // 즐겨찾기 데이터 포함 (새 구조)
                version: '1.4' // 버전 업데이트 (버그 픽스)
            };
        }

        function getInitialFilename() {
            return ''; 
        }
        
        saveBtn.addEventListener('click', (event) => {
            event.preventDefault(); 
            
            const data = exportScheduleData();
            if (data.schedules.length === 0) {
                 showNotification('저장할 일정이 없습니다. 일정을 추가해주세요.');
                 return;
            }

            filenameInput.value = getInitialFilename(); 
            filenameError.classList.add('hidden');
            filenameModal.classList.remove('hidden');
            filenameInput.focus();
        });

        filenameSubmitBtn.addEventListener('click', performDownload);
        
        filenameCancelBtn.addEventListener('click', () => {
            filenameModal.classList.add('hidden');
        });

        filenameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                performDownload();
            }
        });

        function performDownload() {
            const name = filenameInput.value.trim();
            if (!name) {
                filenameError.textContent = '파일 이름을 입력해주세요.';
                filenameError.classList.remove('hidden');
                return;
            }
            
            filenameModal.classList.add('hidden');
            
            const data = exportScheduleData();
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `${name}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification(`'${name}.json' 파일이 PC에 성공적으로 저장되었습니다.`);
        }


        loadBtn.addEventListener('click', () => {
            fileLoadInput.click();
        });
        
        fileLoadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    loadScheduleData(data);
                    showNotification(`'${file.name}' 파일이 성공적으로 불러와졌습니다.`);
                } catch (error) {
                    console.error("Error loading file:", error);
                    showNotification("파일을 불러오는 데 실패했습니다. 파일 형식이 올바른지 확인해주세요.");
                }
            };
            reader.readAsText(file);
            e.target.value = null; 
        });

        function loadScheduleData(data) {
            // Load Favorites first
            if (data.favorites && Array.isArray(data.favorites)) {
                // 기존 버전의 즐겨찾기(stayDuration, remark 포함)를 처리하거나 새 버전을 로드합니다.
                favorites = data.favorites.map(fav => {
                    if (fav.customName && fav.place) {
                        return fav; // 새 버전 구조
                    }
                    // 기존 버전 구조 (v1.2 이하): name, coords, stayDuration, remark
                    // 새 구조로 변환하여 저장 (단, 체류시간/비고는 무시)
                    return {
                        id: fav.id,
                        customName: fav.name, 
                        place: {
                            name: fav.name,
                            coords: fav.coords
                        }
                    };
                });
                saveFavorites(); // 로컬 스토리지에 업데이트
            } else {
                 favorites = [];
                 saveFavorites();
            }

            dayContainer.innerHTML = '';
            dayCount = 0;

            if (!data.schedules || data.schedules.length === 0) {
                 showNotification('불러올 수 있는 유효한 일정 데이터가 파일에 없습니다.');
                 return;
            }

            data.schedules.forEach(schedule => {
                addDay();
                const dayBlock = document.getElementById(`day-${dayCount}`);
                
                dayBlock.querySelector('.date-input').value = schedule.date;
                dayBlock.querySelector(`#start-time-${dayCount}`).value = schedule.startTime; 
                
                const startPointInput = dayBlock.querySelector(`input[id^="start-point"]`);
                const startRemarkInput = dayBlock.querySelector(`input[id^="start-remark"]`);
                
                startPointInput.value = schedule.startPoint.name;
                startPointInput.dataset.lat = schedule.startPoint.coords.lat;
                startPointInput.dataset.lng = schedule.startPoint.coords.lng;
                startRemarkInput.value = schedule.startPoint.remark || ''; 
                
                const placesContainer = dayBlock.querySelector('.drag-container');
                placesContainer.innerHTML = ''; 

                schedule.places.forEach((place, index) => {
                    const placeInput = createPlaceInput(place);
                    placesContainer.appendChild(placeInput);
                    // 이미 값이 채워져 있으므로 자동완성 이벤트만 다시 연결
                    attachAutocomplete(placeInput.querySelector('input[type="text"]')); 
                });
                updatePlaceLabels(dayBlock);
                attachDeleteEvents(dayBlock);
                attachDragAndDrop(dayBlock);
            });
            
            // 불러오기 완료 후 드롭다운 목록 업데이트
            updateAllFavoriteDropdowns();
        }
        
        // Event listeners for password modal
        passwordSubmitBtn.addEventListener('click', checkPasswordAndInitialize);
        function handlePasswordKey(event) {
            if (event.key === 'Enter') {
                checkPasswordAndInitialize();
            }
        }
    </script>
</body>
</html>
